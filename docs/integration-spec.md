# 1С → Warehouse Assistant: CSV специфікація (МВП)

Для кожного потоку даних потрібно налаштувати вивантаження CSV у кодуванні **UTF‑8** з заголовками колонок. Формат дати — `YYYY-MM-DD`, дата+час — `YYYY-MM-DD HH:MM:SS`. Дробові значення через крапку.

## 1. Номенклатура (catalog.csv)
| Поле | Тип | Обов’язкове | Опис / Приклад |
| --- | --- | --- | --- |
| `sku` | string | так | Унікальний код товару (`SKU-001`) |
| `name` | string | так | Назва (`Пральний порошок Ariel 3 кг`) |
| `category` | string | так | Категорія / група |
| `uom` | string | так | Одиниця виміру (`шт`, `кг`) |
| `supplier_id` | string | так | Код постачальника (`SUP-1`) |
| `moq` | number | ні | Мінімальне замовлення (шт) |
| `pack_size` | number | ні | Розмір упаковки |
| `shelf_life_days` | number | ні | Термін придатності в днях |
| `updated_at` | datetime | так | Коли запис змінено (`2025-11-10 03:15:00`) |

## 2. Продажі (sales.csv)
| Поле | Тип | Обов’язкове | Опис |
| --- | --- | --- | --- |
| `date` | date | так | Дата продажу (`2025-11-10`) |
| `order_id` | string | так | Номер замовлення (`ORD-1005`) |
| `line_id` | string | так | Ідентифікатор рядка (щоб відрізняти позиції) |
| `sku` | string | так | Код товару |
| `qty` | number | так | Кількість (може бути від’ємною для повернення) |
| `unit_price` | number | ні | Ціна за одиницю |
| `net_amount` | number | ні | Сума рядка після знижок |
| `warehouse_id` | string | так | Код складу (`WH-1`) |
| `channel` | string | ні | Канал (`online`, `retail`, …) |
| `status` | string | ні | Статус (`fulfilled`, `returned`, …) |
| `updated_at` | datetime | так | Час оновлення |

## 3. Залишки (stock.csv)
| Поле | Тип | Обов’язкове | Опис |
| --- | --- | --- | --- |
| `date` | date | так | Дата зняття залишків |
| `sku` | string | так | Код товару |
| `warehouse_id` | string | так | Код складу |
| `qty_on_hand` | number | так | Залишок на складі |
| `batch_id` | string | ні | Партія (`B-1021`) |
| `expiry_date` | date | ні | Мінімальна дата придатності |
| `updated_at` | datetime | так | Коли рядок оновлено |

## 4. Поставки / PO (po.csv)
| Поле | Тип | Обов’язкове | Опис |
| --- | --- | --- | --- |
| `po_id` | string | так | Номер замовлення постачальнику |
| `supplier_id` | string | так | Код постачальника |
| `sku` | string | так | Код товару |
| `qty` | number | так | Кількість в замовленні |
| `ordered_at` | datetime | так | Дата створення замовлення |
| `received_at` | datetime | ні | Дата фактичного приходу (якщо ще в дорозі — пусто) |
| `moq` | number | ні | MOQ для цього замовлення |
| `pack_size` | number | ні | Pack size |
| `updated_at` | datetime | так | Час зміни |

## 5. Постачальники (suppliers.csv)
| Поле | Тип | Обов’язкове | Опис |
| --- | --- | --- | --- |
| `supplier_id` | string | так | Унікальний код (`SUP-1`) |
| `name` | string | так | Назва |
| `lead_time_days_default` | number | ні | Середній LT за замовчуванням |
| `contact` | string | ні | Email/телефон |
| `updated_at` | datetime | так | Час змін |

## 6. Склади (warehouses.csv)
| Поле | Тип | Обов’язкове | Опис |
| --- | --- | --- | --- |
| `warehouse_id` | string | так | Код складу (`WH-1`) |
| `name` | string | так | Назва складу |
| `timezone` | string | ні | Часовий пояс (`Europe/Kyiv`) |
| `updated_at` | datetime | так | Час зміни |

## Рекомендації по обміну
- **Частота**: продажі й залишки — щодня (краще до 02:00), PO — при зміні, номенклатура/постачальники — раз/тиждень або при оновленнях.
- **Доставка файлів**: SFTP/HTTP POST/WebDAV; головне — уникати “ручного” копіювання.
- **Ідентифікація**: усі HTTP-запити до `/api/ingest/*` повинні містити заголовок `X-API-Key` (видається у налаштуваннях акаунта). Ключ визначає, в яку організацію потраплять дані.
- **Ідемпотентність**: бекенд робить upsert за ключами (`sku`, `order_id+line_id`, `po_id+sku`, тощо), тому можна передавати інкрементальні вибірки — достатньо фільтрувати по `updated_at`.

## Конектор: як автоматично віддавати дані з 1С/ERP
Щоб не переносити CSV вручну, варто розгорнути невеликий конектор (скрипт/сервіс), який:

1. **Збирає дані** з джерела (1С, ERP, CRM, WMS) будь-яким доступним способом: читання файлів з SFTP, виклики їхнього API, обробка вебхуків або черги. Кожний потік (catalog, sales, stock тощо) має свій розклад (наприклад, продажі — щодня о 00:30, залишки — 00:45, PO — при зміні).
2. **Нормалізує** записи під нашу схему: вирівнює формати дат/чисел, додає обов’язкові коди (`warehouse_id`, `supplier_id`), підставляє `updated_at`, формує ключі (`order_id+line_id`, `po_id+sku`), очищує від зайвих колонок.
3. **Ідентифікує організацію** через API ключ. Усі запити містять заголовок `X-API-Key: wa_xxx`, який адміністратор генерує у веб-інтерфейсі. Якщо клієнт має кілька організацій, у конфігурації конектора зберігаємо `org_id`, `api_key`, мапи складів тощо.
4. **Надсилає дані** на наші ендпоінти `/api/ingest/*` (JSON). Великі CSV можна парсити стрімом і відправляти батчами (по 5–10 тис. рядків). Важливо реалізувати повторні спроби, exponential backoff і логування помилок.
5. **Підтримує ідемпотентність**: конектор може повторно відправляти частину старих рядків — бекенд зробить upsert за ключами. Для інкрементальних оновлень зручно зберігати в локальному state (sqlite/redis) значення `last_successful_updated_at` для кожного потоку.
6. **Моніторить стан**: метрики/логи, сповіщення про n підряд невдалих спроб, health-check нашого API перед відправкою.

Архітектурно це може бути cron-сервіс із такими модулями:
- scheduler (Cron/BullMQ) → запускає job “sales”, “stock”, “po”;
- data source adapters (`OneCFileSource`, `RetailCRMApiSource`) → повертають масив DTO;
- normalizer → мапить DTO до наших схем (див. таблиці вище);
- transport → відправляє запит `POST https://.../api/ingest/<stream>` з API-ключем;
- state store → зберігає останні мітки часу.

Такий конектор дозволяє клієнту один раз налаштувати вивантаження/доступ у своїй системі, а далі дані потрапляють у Warehouse Assistant автоматично та без ручних операцій.
